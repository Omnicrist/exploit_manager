import json
import util_marshal
from settings import Singleton
from pwn import *
# need to to "from pwn import *" because with the globals mechanism I would have an "import pwn"
# and pwn is usually used with a *-import


class CustomSubmitter(metaclass=Singleton):
    def __init__(self, settings, caller_globals):
        if settings.submit_protocol.upper() == 'CUSTOM':
            submitter_file = settings.custom_submitter_file
            globals().update(caller_globals)
            with open(submitter_file, 'r') as f:
                serial = json.load(f)
            self.submitter = util_marshal.unserialize_submitter(serial, globals())

    def submit(self, flag, target_url, team_token):
        return self.submitter['submitter'](flag, target_url, team_token)
