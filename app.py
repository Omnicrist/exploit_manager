#!/usr/bin/env python3
import flask
import json
import db_utils
import utils
import manager
import os

app = flask.Flask(__name__)
app.json_list = []


@app.route('/favicon.ico', methods=["GET"])
def favicon():
    return flask.send_from_directory(os.path.join(app.root_path, 'static', 'images'), 'uninap.png', mimetype='image/png')

@app.route('/', methods=['GET'])
def index():
    """HOME DELL'INTERFACCIA"""

    return flask.render_template('/public_html/index.html')


@app.route('/exploits', methods=['GET'])
def exploits():
    """PAGINA PER LA GESTIONE DEGLI EXPLOITS
    DA QUI SI PUO' EFFETTUARE L'UPLOAD"""
    
    return flask.render_template('/public_html/upload.html')


@app.route('/api/getExploits', methods=['GET'])
def getExploits():
    """RITORNA GLI EXPLOITS E I RELATIVI DATI"""

    # Reading exploits stats from db
    db = db_utils.connect()
    data = db_utils.get_count_attacks(db)
    db.close()

    # Summing the flags obtained by an exploit for each opponent
    totals = dict([ (_json["service"], 0) for _json in app.json_list])
    for info in data:
        if info[2] in totals.keys():
            totals[info[2]] += info[0]

    response = app.response_class(
        response = json.dumps({"services": app.json_list, "totals": totals}),
        status = 200,
        mimetype='application/json'
    )
    return response


@app.route('/api/uploadExploit', methods=['POST'])
def uploadExploit():
    """UPLOAD DEGLI EXPLOIT"""
    global settings
    
    try:
        f = flask.request.files['myFile']
    except ValueError:
        utils.log_err("POST REQUEST SENZA FILE\n")
        return redirect('/exploits')

    if f.filename == '':
        utils.log_err("EXPLOIT UPLOAD VUOTO\n")
        return redirect('/exploits')

    json_str = json.loads(f.read().decode("utf-8"))
    
    manager.run_exploits(json_str, settings, globals())

    app.json_list.append(json.loads(json_str))

    return flask.redirect('/exploits')


@app.route('/api/getTargets', methods=['GET'])
def getTargets():
    """RETURN TARGETS DATA"""

    data = {}

    if "service" in flask.request.args.keys():
        if "targets" in flask.request.args.keys():
            # request of targets data for a given service
            data = {}
        else:
            # request of all targets data for a given service
            #data = placeholder_function()
            data = {"targets": [{"name": "Paolo", "flag": 69, "active": 1}, {"name": "Marco", "flag": 420, "active": 0}]}
    else:
        data = {"error": "Invalid parameters"}

    response = app.response_class(
        response = json.dumps(data),
        status = 200,
        mimetype='application/json'
    )
    return response


def init():
    global settings
    settings = manager.load_setup(globals())

if __name__ == '__main__':
    init()
    app.run(debug=True)