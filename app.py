#!/usr/bin/env python3
import flask
import json
import db_utils
import utils
import manager

app = flask.Flask(__name__)
app.json_list = []

@app.route('/', methods=['GET'])
def index():
    """HOME DELL'INTERFACCIA"""

    return flask.render_template('/public_html/index.html')


@app.route('/exploits', methods=['GET'])
def exploits():
    """PAGINA PER LA GESTIONE DEGLI EXPLOITS
    DA QUI SI PUO' EFFETTUARE L'UPLOAD"""
    
    # Reading exploits stats from db
    db = db_utils.connect()

    data = db_utils.get_count_attacks(db)

    db.close()

    # Summing the flags obtained by an exploit for each opponent
    totals = dict([ (_json["service"], 0) for _json in app.json_list])
    for info in data:
        if info[2] in totals.keys():
            totals[info[2]] += info[0]

    return flask.render_template('/public_html/upload.html', jsons=app.json_list, totals=totals)


@app.route('/exploits', methods=['POST'])
def upload():
    """UPLOAD DEGLI EXPLOIT"""
    global settings
    
    try:
        f = flask.request.files['myFile']
    except ValueError:
        utils.log_err("POST REQUEST SENZA FILE\n")
        return redirect(flask.request.url)

    if f.filename == '':
        utils.log_err("EXPLOIT UPLOAD VUOTO\n")
        return redirect(flask.request.url)

    json_str = json.loads(f.read().decode("utf-8"))
    
    manager.run_exploits(json_str, settings, globals())

    app.json_list.append(json.loads(json_str))

    return flask.redirect(flask.request.url)


def init():
    global settings
    settings = manager.load_setup(globals())

if __name__ == '__main__':
    init()
    app.run(debug=True)
